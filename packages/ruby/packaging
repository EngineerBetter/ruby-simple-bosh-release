set -e -x

tar xzf ruby/ruby-2.7.4.tar.gz
pushd ruby-2.7.4
  ./configure \
    --prefix=${BOSH_INSTALL_TARGET} \
    --disable-install-doc

  make
  make install
popd

tar zxvf ruby/rubygems-3.2.29.tgz
pushd rubygems-3.2.29
  ${BOSH_INSTALL_TARGET}/bin/ruby setup.rb
popd

# We need to replace the shebang in the default binstubs generated by rubygems.
# As of rubygems 2.7.6 and ruby 2.4.4 they fixed a vulnerability with regards
# to path traversal and symlinks. The resulting fix uses the real path for the
# shebang which includes a checksum that is not constant across BOSH vms. See
# https://blog.rubygems.org/2018/02/15/2.7.6-released.html for more details.
sed -i '1s%.*%#!/var/vcap/packages/ruby/bin/ruby%' /var/vcap/packages/ruby/bin/gem
sed -i '1s%.*%#!/var/vcap/packages/ruby/bin/ruby%' /var/vcap/packages/ruby/bin/bundle
